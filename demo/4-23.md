---
  title: 'H5端获取摄像头进行扫码',
  date: 2019-04-23
---

## getUserMedia了解

HTML5的getUserMedia API为用户提供访问硬件设备媒体（摄像头、麦克风）的接口，基于该接口，开发者可以在不依赖任何浏览器插件的条件下访问硬件媒体设备。
[点击查看getUserMedia的api](https://developer.mozilla.org/zh-CN/docs/Web/API/MediaDevices/getUserMedia)

## getUserMedia使用

```
// constrains是配置项对象，具体可以看文档
const init = ({constrains,videoElement}) => {
  if(navigator.mediaDevices.getUserMedia){
    //最新标准API
    navigator.mediaDevices.getUserMedia(constrains).then(stream => { success(stream,videoElement) }).catch(err => { error(err) });
  } else if (navigator.webkitGetUserMedia){
    //webkit内核浏览器
    navigator.webkitGetUserMedia(constrains).then(stream => { success(stream,videoElement) }).catch(err => { error(err) });
  } else if (navigator.mozGetUserMedia){
    //Firefox浏览器
    navagator.mozGetUserMedia(constrains).then(stream => { success(stream,videoElement) }).catch(err => { error(err) });
  } else if (navigator.getUserMedia){
    //旧版API
    navigator.getUserMedia(constrains).then(stream => { success(stream,videoElement) }).catch(err => { error(err) });
  }
};

const success = (stream,videoElement) => {
  //绘制canvas用于捕捉视频流截图
  let canvas = document.createElement('canvas');
  canvas.style.display = 'none';
  canvas.width = 478;
  canvas.height = 850;
  //将视频流设置为video元素的源
  videoElement.srcObject = stream;
  //播放视频
  videoElement.play();
  // 获取摄像头分辨率
  videoElement.oncanplay = function () {
    // 摄像头分辨率,手机默认480x640,如果需要可以把分辨率宽高传入screenshot进行截图
    console.log(videoElement.videoWidth,videoElement.videoHeight);
    // 进行截图
    screenshot(canvas);
  };

};

const error = err => {
  console.log("访问用户媒体设备失败：",err.name,err.message);
};

const screenshot = (canvas) => {
  //视频截图
  let context = canvas.getContext("2d");
  // 具体坐标可以根据实际进行调整
  context.drawImage(videoElement,0,0,478,850,0,0,478,850);
  //canvas转base64
  let imgUri = canvas.toDataURL();
  //扫码操作，可以本地调用第三方库，也可以发给后端进行解析
};
```

## 注意事项

* video标签里面的视频会用黑边，可以在video标签的css中加入 `object-fit: cover;`

* ios中会出现点击视频全屏情况，可以在video标签中加入 `playsinline="true" webkit-playsinline="true"`

